# Feature Discovery Report
## 1) Dataset summary
- Path: `data/external/output_1d_labels.csv`
- Rows: 1848
- Overall label counts: `{'skip': 814, 'long': 531, 'short': 503}`
- Train label counts: `{'skip': 615, 'long': 443, 'short': 420}`
- Valid label counts: `{'skip': 101, 'long': 43, 'short': 41}`
- Test label counts: `{'skip': 98, 'long': 45, 'short': 42}`

## 2) Feature preparation
- Excluded OHLCV columns: `['open', 'high', 'low', 'close', 'volume', 'high_low_range_pct', 'days_since_high', 'below_period_high_20d', 'below_period_high_60d', 'lower_shadow', 'lower_shadow_pct', 'stoch_k_slow_14', 'stoch_d_slow_21', 'volume_roc_12', 'volume_roc_25', 'volume_oscillator_5_10', 'volume_oscillator_12_26', 'money_flow', 'money_flow_sma_10', 'volume_sma_5', 'volume_sma_20', 'volume_sma_100', 'volume_ratio_10', 'volume_ratio_50', 'klinger_volume_osc', 'klinger_volume_signal', 'vsa_rel_volume', 'vsa_close_position', 'updown_volume_ratio_10', 'updown_volume_ratio_20', 'volume_trend_14', 'volume_trend_21', 'volume_std_10', 'volume_std_20', 'volume_std_50', 'volume_momentum_10', 'volume_momentum_14', 'volume_momentum_20']`
- Excluded time columns: `['timestamp', 'date']`
- Feature counts: initial=236, after_constant=233, after_corr=199
- Missingness mean: before=0.012721, after=0.000000

## 3) Global results
### LONG
- PR-AUC full: valid=0.4556, test=0.3702
- PR-AUC trusted: valid=0.3157, test=0.2696
- Top 20 fused: ['peak_count_20d', 'tr_percentile_50d', 'atr_28', 'momentum_14', 'atr_7', 'obv', 'max_drawdown_20d', 'atr_pct_14', 'cci_30', 'realized_vol_20d', 'up_capture_20d', 'dpo_14', 'peak_count_60d', 'distance_from_support_50d', 'stoch_d_full_21', 'cumulative_return_252d', 'avg_loss_20d', 'position_in_range_50d', 'aroon_down_14', 'rsi_7']
- Top 20 stability: ['peak_count_20d', 'atr_28', 'momentum_14', 'max_drawdown_20d', 'obv', 'cci_30', 'atr_pct_14', 'mass_index', 'roc_9', 'stoch_d_full_21', 'dpo_14', 'rsi_7', 'plus_di_14', 'cumulative_return_252d', 'qstick_8', 'returns_25th_252d', 'avg_loss_60d', 'ppo_histogram_12_26', 'overnight_return', 'atr_7']
- Trusted top 20 (feature, stability, ks): [{'feature': 'peak_count_20d', 'stability_freq': 1.0, 'ks': 0.16587169169365656}]
### SHORT
- PR-AUC full: valid=0.3573, test=0.3331
- PR-AUC trusted: valid=0.3364, test=0.3194
- Top 20 fused: ['atr_pct_14', 'price_range_pct_7', 'returns_75th_252d', 'up_capture_60d', 'vw_rsi_14', 'obv', 'returns_iqr_252d', 'down_capture_20d', 'max_drawdown_20d', 'price_range_pct_14', 'ulcer_index_14', 'avg_loss_20d', 'elder_bear_power_13', 'var_99_60d', 'vpci_10', 'pvi_ema', 'parkinson_vol_30', 'vzo_28', 'returns_iqr_60d', 'tr']
- Top 20 stability: ['atr_pct_14', 'price_range_pct_7', 'returns_75th_252d', 'up_capture_60d', 'vw_rsi_14', 'obv', 'returns_iqr_252d', 'down_capture_20d', 'vpci_10', 'vzo_28', 'peak_count_20d', 'force_index_ema_13', 'vwmacd_histogram', 'intraday_intensity_sum_30', 'eom_20', 'eom_14', 'vpci_5', 'vsa_signal', 'tmf_21', 'pvi_ema']
- Trusted top 20 (feature, stability, ks): [{'feature': 'atr_pct_14', 'stability_freq': 1.0, 'ks': 0.18280673327932306}, {'feature': 'price_range_pct_7', 'stability_freq': 1.0, 'ks': 0.1504905932127104}, {'feature': 'returns_75th_252d', 'stability_freq': 1.0, 'ks': 0.15202988567827888}, {'feature': 'up_capture_60d', 'stability_freq': 1.0, 'ks': 0.1542353047078945}, {'feature': 'obv', 'stability_freq': 1.0, 'ks': 0.14601224232604196}, {'feature': 'returns_iqr_252d', 'stability_freq': 1.0, 'ks': 0.16394815014852823}, {'feature': 'down_capture_20d', 'stability_freq': 1.0, 'ks': 0.16332703213610586}, {'feature': 'vpci_10', 'stability_freq': 1.0, 'ks': 0.1031280943379242}, {'feature': 'pvi_ema', 'stability_freq': 0.995, 'ks': 0.169056620757944}, {'feature': 'force_index_ema_13', 'stability_freq': 1.0, 'ks': 0.1122603294625979}, {'feature': 'eom_14', 'stability_freq': 1.0, 'ks': 0.12042938158250067}]
### SKIP
- PR-AUC full: valid=0.6631, test=0.6168
- PR-AUC trusted: valid=0.6546, test=0.5947
- Top 20 fused: ['price_range_pct_7', 'peak_count_20d', 'parkinson_vol_30', 'atr_pct_14', 'realized_vol_10d', 'vol_of_vol_20d', 'max_drawdown_20d', 'returns_25th_252d', 'vpci_10', 'obv', 'ad_line', 'pvi_ema', 'vwap', 'tr', 'avg_loss_60d', 'returns_kurtosis_60d', 'std_dev_10', 'vsa_signal', 'nvi_ema', 'distance_from_resistance_20d']
- Top 20 stability: ['price_range_pct_7', 'peak_count_20d', 'atr_pct_14', 'vol_of_vol_20d', 'vsa_signal', 'vwap', 'obv', 'win_rate_20d', 'consecutive_up_days', 'realized_vol_5d', 'returns_kurtosis_60d', 'fractal_dimension_60d', 'trough_count_20d', 'days_above_sma_200', 'chaikin_oscillator_3_10', 'ulcer_index_14', 'cci_30', 'upper_shadow_pct', 'aroon_down_14', 'fractal_dimension_120d']
- Trusted top 20 (feature, stability, ks): [{'feature': 'price_range_pct_7', 'stability_freq': 1.0, 'ks': 0.17937615992614156}, {'feature': 'peak_count_20d', 'stability_freq': 1.0, 'ks': 0.10003862495171881}, {'feature': 'atr_pct_14', 'stability_freq': 1.0, 'ks': 0.2131475567362858}, {'feature': 'vol_of_vol_20d', 'stability_freq': 1.0, 'ks': 0.11470857002892161}, {'feature': 'obv', 'stability_freq': 1.0, 'ks': 0.181712498469133}, {'feature': 'returns_kurtosis_60d', 'stability_freq': 1.0, 'ks': 0.11111927573505168}, {'feature': 'realized_vol_5d', 'stability_freq': 1.0, 'ks': 0.12474540504385345}, {'feature': 'ulcer_index_14', 'stability_freq': 1.0, 'ks': 0.1274001639205268}]

## 4) Regime results
- Chosen K by BIC: **6**
- BIC table: `{3: 36926.4071347431, 4: 35721.355145644724, 5: 33550.880483573594, 6: 31675.535967093474}`
- Regime sizes: `{0: 207, 1: 225, 2: 143, 3: 331, 4: 264, 5: 678}`
### Regime 0
- Summary: `{'note': 'insufficient rows by split'}`
### Regime 1
- Summary: `{'note': 'insufficient rows by split'}`
### Regime 2
- Summary: `{'note': 'insufficient rows by split'}`
### Regime 3
- Summary: `{'note': 'insufficient rows by split'}`
### Regime 4
- Summary: `{'note': 'insufficient rows by split'}`
### Regime 5
- Summary: `{'long': {'class': 'long', 'best_c': 1, 'full_valid_ap': 0.38224696447672524, 'full_test_ap': 0.33379022407115627, 'trusted_valid_ap': 0.33837615812957195, 'trusted_test_ap': 0.2951178502658921, 'top20_fused': ['realized_vol_10d', 'peak_count_20d', 'atr_pct_14', 'realized_vol_20d', 'momentum_14', 'adx_14', 'ppo_histogram_12_26', 'parkinson_vol_30', 'days_above_sma_20', 'std_dev_10', 'realized_vol_60d', 'max_drawdown_20d', 'obv', 'distance_from_resistance_20d', 'max_drawdown_60d', 'bb_width_10', 'avg_gain_60d', 'aroon_down_14', 'trough_count_20d', 'chaikin_volatility_20'], 'top20_stability': ['realized_vol_10d', 'peak_count_20d', 'realized_vol_20d', 'adx_14', 'momentum_14', 'ppo_histogram_12_26', 'parkinson_vol_30', 'overnight_return', 'days_above_sma_20', 'obv', 'max_drawdown_20d', 'max_drawdown_60d', 'trough_count_20d', 'avg_gain_60d', 'bb_width_10', 'mass_index', 'chaikin_volatility_20', 'minus_di_14', 'returns_median_60d', 'tii_60'], 'trusted_top20': [{'feature': 'realized_vol_10d', 'stability_freq': 1.0, 'ks': 0.11666666666666667}, {'feature': 'realized_vol_20d', 'stability_freq': 1.0, 'ks': 0.16216867469879517}, {'feature': 'parkinson_vol_30', 'stability_freq': 1.0, 'ks': 0.1380722891566265}, {'feature': 'max_drawdown_20d', 'stability_freq': 1.0, 'ks': 0.13164658634538154}, {'feature': 'obv', 'stability_freq': 1.0, 'ks': 0.1151004016064257}], 'trusted_top10': ['realized_vol_10d', 'realized_vol_20d', 'parkinson_vol_30', 'max_drawdown_20d', 'obv']}, 'short': {'class': 'short', 'best_c': 10, 'full_valid_ap': 0.34451314687708406, 'full_test_ap': 0.28827046647501675, 'trusted_valid_ap': 0.30234818097242405, 'trusted_test_ap': 0.2804510482954917, 'top20_fused': ['price_range_pct_7', 'mass_index', 'peak_count_20d', 'max_drawdown_20d', 'parkinson_vol_30', 'pvi_ema', 'atr_28', 'realized_vol_20d', 'price_range_pct_14', 'schaff_trend_cycle', 'std_dev_10', 'nvi_ema', 'distance_from_support_20d', 'body', 'pvi', 'atr_pct_14', 'stoch_d_full_21', 'price_range_pct_21', 'fractal_dimension_60d', 'bb_width_20'], 'top20_stability': ['price_range_pct_7', 'mass_index', 'peak_count_20d', 'max_drawdown_20d', 'pvi_ema', 'schaff_trend_cycle', 'realized_vol_20d', 'bb_width_10', 'bb_width_30', 'body', 'stoch_d_full_21', 'position_in_range_10d', 'cci_14', 'adx_14', 'mfi_20', 'returns_50d', 'days_above_sma_200', 'ppo_histogram_12_26', 'trough_count_20d', 'price_position_14'], 'trusted_top20': [{'feature': 'price_range_pct_7', 'stability_freq': 1.0, 'ks': 0.1613985779306584}, {'feature': 'mass_index', 'stability_freq': 1.0, 'ks': 0.12439960567988757}, {'feature': 'peak_count_20d', 'stability_freq': 1.0, 'ks': 0.12196656668834029}, {'feature': 'max_drawdown_20d', 'stability_freq': 1.0, 'ks': 0.1339849403276213}, {'feature': 'pvi_ema', 'stability_freq': 1.0, 'ks': 0.14174549573169454}, {'feature': 'realized_vol_20d', 'stability_freq': 1.0, 'ks': 0.12412693751704176}, {'feature': 'schaff_trend_cycle', 'stability_freq': 1.0, 'ks': 0.12326698408037419}, {'feature': 'mfi_20', 'stability_freq': 1.0, 'ks': 0.10390754451832121}, {'feature': 'bb_width_10', 'stability_freq': 1.0, 'ks': 0.1459823394928372}], 'trusted_top10': ['price_range_pct_7', 'mass_index', 'peak_count_20d', 'max_drawdown_20d', 'pvi_ema', 'realized_vol_20d', 'schaff_trend_cycle', 'mfi_20', 'bb_width_10']}, 'skip': {'class': 'skip', 'best_c': 1, 'full_valid_ap': 0.6216547977652852, 'full_test_ap': 0.6025480516944083, 'trusted_valid_ap': 0.5619596013548012, 'trusted_test_ap': 0.6363427409063303, 'top20_fused': ['price_range_pct_7', 'atr_pct_14', 'realized_vol_10d', 'price_range_pct_14', 'realized_vol_60d', 'ad_line', 'r_squared_60d', 'distance_from_support_50d', 'returns_75th_252d', 'returns_5d', 'price_range_pct_21', 'max_drawdown_60d', 'atr_28', 'obv', 'returns_iqr_252d', 'bb_width_20', 'returns_25th_252d', 'parkinson_vol_30', 'vortex_pos_21', 'chaikin_volatility_20'], 'top20_stability': ['price_range_pct_7', 'atr_pct_14', 'realized_vol_10d', 'price_range_pct_14', 'realized_vol_60d', 'r_squared_60d', 'distance_from_support_50d', 'sma_cross_50_200', 'returns_5d', 'atr_28', 'max_drawdown_60d', 'chaikin_volatility_20', 'bb_width_20', 'cci_14', 'stoch_d_fast_14', 'avg_gain_60d', 'realized_vol_5d', 'kst', 'bb_pct_10', 'max_consecutive_up_20d'], 'trusted_top20': [{'feature': 'price_range_pct_7', 'stability_freq': 1.0, 'ks': 0.16808003298850782}, {'feature': 'atr_pct_14', 'stability_freq': 1.0, 'ks': 0.23394947738315075}, {'feature': 'realized_vol_10d', 'stability_freq': 1.0, 'ks': 0.1871739247360023}, {'feature': 'price_range_pct_14', 'stability_freq': 1.0, 'ks': 0.1993653297954354}, {'feature': 'realized_vol_60d', 'stability_freq': 1.0, 'ks': 0.19784140416300625}, {'feature': 'r_squared_60d', 'stability_freq': 1.0, 'ks': 0.11701956003370564}, {'feature': 'distance_from_support_50d', 'stability_freq': 1.0, 'ks': 0.11481435000089643}, {'feature': 'max_drawdown_60d', 'stability_freq': 1.0, 'ks': 0.17198845402226726}, {'feature': 'atr_28', 'stability_freq': 1.0, 'ks': 0.13564730982304535}, {'feature': 'bb_width_20', 'stability_freq': 1.0, 'ks': 0.18367786004984132}, {'feature': 'avg_gain_60d', 'stability_freq': 1.0, 'ks': 0.17526937626620293}, {'feature': 'realized_vol_5d', 'stability_freq': 1.0, 'ks': 0.1286193233770192}], 'trusted_top10': ['price_range_pct_7', 'atr_pct_14', 'realized_vol_10d', 'price_range_pct_14', 'realized_vol_60d', 'r_squared_60d', 'distance_from_support_50d', 'max_drawdown_60d', 'atr_28', 'bb_width_20']}}`
- Regime conditioning improved separation for long/short: **Yes**

## 5) Recommendations
- Start with global trusted features (top-ranked by fused rank and stability gate).
- Consider separate per-regime models only if regime trusted PR-AUC consistently beats global.
- If class separation remains weak, refine labels or adjust prediction horizon.
